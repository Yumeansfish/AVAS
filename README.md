# AVAS

## Change in ner version Jun17
- 1.Now any video in the page has its own survey
- 2.build the dist and push the dist on github 
- now init_aw_webui only responsible for:
- a: search the path of the aw/static and replace it by dist
- b: restart activitywatch
- 3.video_handler will delete the .mp4 in local folder generated by converting non-mp4 files automatically

## Change in new version Jun3
- Packaged WebUI deployment into init_aw_webui.py
- Move all configuration to config.py(includes Google sheet,AWS configuration ...)
- Made sensitive information into environment variables, and use init_env.py to help users build .env
- Added automatic deletion of related videos after questionnaire submission (refers to deleting corresponding videos on S3)

## Change in new version May 25
- to avoid re-submission,every generated pages will be destroyed after sumbit result
- in everyday 1 am,delete all the generated pages existed over 7 days(even it was'not been submitted)

## Change in new version May 12
- delete gui folder and all the gui.py
- move the batch_interval setting from handler.py to config.py
- now every setting is finished in config.py
- merge all the videos files in the same webpage and only call appscript once
- add logic in appscript to handle the localhost url in the webpage

## Project Overview
The Video Handler module listens for new video files (`.mov`, `.avi`, `.mp4`) in a specified directory. Once a file has finished writing, non-MP4 videos are automatically transcoded to MP4 (H.264 + AAC, faststart). The resulting file is uploaded to AWS S3, a Google Apps Script endpoint is called to update or create a remote page, and a notification is sent. 

## Key Features
- Automatic detection of new `.mov`, `.avi`, and `.mp4` files  
- Transcoding to MP4 with H.264 video, AAC audio, and `+faststart` for streaming  
- Skip handling of already–transcoded MP4 files to prevent duplication  
- Upload to a configurable S3 bucket  
- Integration with Google Apps Script for remote page updates  
- Notification by email
- Implement a queue in handler so that the videos entering in the folder in a given interval will be handled together

## Environment & Dependencies
- **Python:** 3.8  

## Amazon S3 sign up and bucket creation
- Go to website https://aws.amazon.com/cn/s3/
- click sign up and finish the signing up

- S3 part
- Search S3
- Click "create bucket"
- Unselect "block all public access"
- Other setting can use the default setting
- After create the bucket
- Click "Permissions"
- In the "Bucket policy" part, click "edit"
- Paste the following code in it (replace "your_bucket_name" with your real bucket name)
- Save changes
- 
```
  {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::your_bucket_name/*"
        }
    ]
}
```
- IAM part
- Search IAM
- Click "users"
- Click "create user"
- In step2 "Permissions options"
- Choose "Attach polices directly"
- Then search "AmazonS3FullAccess" in "Permission policies"
- select "AmazonSeFullAccess"
- In Step3 ,Click "create user"

- Return back to user page and click the user you created just now
- You can find in "Summary" has a "Access key" part
- Click "create Access key"
- In step1: choose "Local code."
- You can skip step2
- In step3: dowload .csv to store your own access key and secret key
- **The secret key will only show once in Step3! So don't click so fast without dowload the .csv**

## Installation & Configuration
- The basic steps includes:
- 0.sign up in AWS and create bucket(see Amazon S3 sign up and bucket creation)
- 1.install requirements.txt
- 2.run init_aw_webui.py(now use mannual moving reaplce this step,see activitywatch)
- 3.run init_env.py ,set all the sensitive configuration

```
git clone <repository_url>
cd <repository_folder>
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
python3 init_aw_webui.py #(now use mannual moving reaplce this step,see activitywatch)
python3 init_env.py #Do this step in terminal instead of IDE
```
- change/set other non-sensitive configuration in config.py

## Usage Instructions
```bash
python3 -m core.main
```
- then it will start monitor the target folder automatically
 
## ActivityWatch(This part in only for back-up operation when init_aw_webui.py fail)
- find the real path of the static folder of activityWatch
- an example in linux:
- /home/trustme/activitywatch/aw-server/aw-server/static/
- copy all the contents in AVAS/dist and paste in static folder to replace all orginal contents

## two-step verification of the sender email
- link :https://myaccount.google.com/signinoptions/twosv?rapt=AEjHL4P36Mfg_YQ5JLfwGiqb6iM2tQaLWa4cKI8fhwGOZJMRha7quAqOc4eH7P3zXSASs-LVrVXeL1bHgEp51hPAgGyzbeWj3trex6zrbrlmi1g_KkAAKLI


## Directory Structure
```text
├── core/
│   ├── __init__.py
│   ├── appscript_client.py
│   ├── config.py
│   ├── main.py
│   ├── monitor.py
│   ├── notifier.py
│   ├── survey_loader.py
│   ├── video_handler.py
│   ├── video_metadata.py
│   └── video_processor.py
├── data/
│   ├── surveys/
│   └── video/
├── dist/
│   ├── css/
│   ├── fonts/
│   ├── js/
│   ├── index.html
│   ├── manifest.json
│   ├── service-worker.js
│   └── workbox-6567b62a.js
├── init_aw_webui.py
├── init_env.py
├── README.md
└── requirements.txt
```




